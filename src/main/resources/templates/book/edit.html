<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Book</title>
    <th:block th:replace="~{layout::link-css}"></th:block>
    <th:block th:replace="~{layout::custom-css}"></th:block>
</head>
<body class="d-flex flex-column" style="min-height: 100vh;">
    <th:block th:replace="~{layout::header}"></th:block>

    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10">
                <div class="card shadow-lg">
                    <div class="card-header text-center py-3">
                        <h2 class="mb-0"><i class="bi bi-pencil-square"></i> Edit Book</h2>
                    </div>
                    <div class="card-body p-4">
                        <form th:action="@{/books/edit}" th:object="${book}" method="post" enctype="multipart/form-data">
                            <input type="hidden" th:field="*{id}">
                            
                            <div class="mb-3">
                                <label for="title" class="form-label"><i class="bi bi-book"></i> Title:<span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="title" th:field="*{title}" th:classappend="${#fields.hasErrors('title')} ? 'is-invalid' : ''" required>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="author" class="form-label"><i class="bi bi-person"></i> Author:<span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="author" th:field="*{author}" th:classappend="${#fields.hasErrors('author')} ? 'is-invalid' : ''" required>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('author')}" th:errors="*{author}"></div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="price" class="form-label"><i class="bi bi-cash"></i> Price:<span class="text-danger">*</span></label>
                                <input type="number" step="0.01" class="form-control" id="price" th:field="*{price}" th:classappend="${#fields.hasErrors('price')} ? 'is-invalid' : ''" required>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('price')}" th:errors="*{price}"></div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="category" class="form-label"><i class="bi bi-tag"></i> Category:<span class="text-danger">*</span></label>
                                <select class="form-control" id="category" th:field="*{category.id}" th:classappend="${#fields.hasErrors('category')} ? 'is-invalid' : ''" required>
                                    <option value="">-- Select Category --</option>
                                    <option th:each="category : ${categories}" th:value="${category.id}" th:text="${category.name}"></option>
                                </select>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('category')}" th:errors="*{category}"></div>
                            </div>
                            
                            <!-- Hi·ªÉn th·ªã ·∫£nh hi·ªán t·∫°i -->
                            <div class="mb-3" th:if="${book.images != null && !book.images.isEmpty()}">
                                <label class="form-label"><i class="bi bi-images"></i> ·∫¢nh hi·ªán t·∫°i:</label>
                                <div class="row">
                                    <div class="col-md-3 mb-3" th:each="image : ${book.images}">
                                        <div class="card">
                                            <img th:src="@{${image.imageUrl}}" class="card-img-top" alt="Book image" style="height: 150px; object-fit: cover;">
                                            <div class="card-body p-2">
                                                <div class="form-check">
                                                    <input type="checkbox" class="form-check-input" name="deleteImageIds" th:value="${image.id}" th:id="'delete-' + ${image.id}">
                                                    <label class="form-check-label" th:for="'delete-' + ${image.id}">
                                                        <small>X√≥a ·∫£nh n√†y</small>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Upload ·∫£nh m·ªõi -->
                            <div class="mb-3">
                                <label for="imageFiles" class="form-label"><i class="bi bi-images"></i> Th√™m ·∫£nh m·ªõi (T·ªëi ƒëa 5 ·∫£nh):</label>
                                <input type="file" class="form-control" id="imageFiles" name="imageFiles" multiple accept="image/*" onchange="checkFileCount(this, 5)">
                                <small class="form-text text-muted">Ch·ªçn t·ªëi ƒëa 5 ·∫£nh c√πng l√∫c. ƒê·ªãnh d·∫°ng: JPG, PNG, GIF, WEBP</small>
                            </div>
                            
                            <!-- Video hi·ªán t·∫°i -->
                            <div class="mb-3" th:if="${book.video != null}">
                                <label class="form-label"><i class="bi bi-camera-video"></i> Video hi·ªán t·∫°i:</label>
                                <div class="card">
                                    <div class="card-body">
                                        <video controls style="max-width: 100%; max-height: 300px;">
                                            <source th:src="@{${book.video.videoUrl}}" type="video/mp4">
                                            Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ video.
                                        </video>
                                        <div class="form-check mt-2">
                                            <input type="checkbox" class="form-check-input" name="deleteVideo" value="true" id="deleteVideo">
                                            <label class="form-check-label" for="deleteVideo">
                                                X√≥a video n√†y
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Upload video m·ªõi -->
                            <div class="mb-3">
                                <label for="videoFile" class="form-label"><i class="bi bi-camera-video"></i> <span th:if="${book.video != null}">Thay th·∫ø</span><span th:unless="${book.video != null}">Th√™m</span> video (T·ªëi ƒëa 1 video, 60 gi√¢y):</label>
                                <input type="file" class="form-control" id="videoFile" name="videoFile" accept="video/*">
                                <small class="form-text text-muted">Ch·ªçn 1 video duy nh·∫•t. T·ªëi ƒëa 50MB, kh√¥ng qu√° 60 gi√¢y. ƒê·ªãnh d·∫°ng: MP4, WEBM, OGG</small>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                                <button type="submit" class="btn btn-primary btn-lg me-2">
                                    <i class="bi bi-check-circle"></i> Update Book
                                </button>
                                <a href="/books" class="btn btn-secondary btn-lg">
                                    <i class="bi bi-x-circle"></i> Cancel
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div style="flex-grow: 1;"></div>
    <th:block th:replace="~{layout::footer}"></th:block>
    
    <script>
    function checkFileCount(input, maxFiles) {
        if (input.files.length > maxFiles) {
            alert(`B·∫°n ch·ªâ c√≥ th·ªÉ ch·ªçn t·ªëi ƒëa ${maxFiles} ·∫£nh c√πng l√∫c`);
            input.value = '';
        }
    }
    
    // Preview data using REST API format
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        const bookIdInput = document.querySelector('input[type="hidden"][name="id"]');
        const titleInput = document.getElementById('title');
        const authorInput = document.getElementById('author');
        const priceInput = document.getElementById('price');
        const categorySelect = document.getElementById('category');
        
        // Add API Preview button
        const submitButton = form.querySelector('button[type="submit"]');
        const previewBtn = document.createElement('button');
        previewBtn.type = 'button';
        previewBtn.className = 'btn btn-info btn-lg me-2';
        previewBtn.innerHTML = '<i class="bi bi-eye"></i> Preview API Data';
        submitButton.parentElement.insertBefore(previewBtn, submitButton);
        
        previewBtn.addEventListener('click', function() {
            const bookData = {
                title: titleInput.value,
                author: authorInput.value,
                price: parseFloat(priceInput.value),
                categoryId: parseInt(categorySelect.value)
            };
            
            if (!bookData.title || !bookData.author || !bookData.price || !bookData.categoryId) {
                alert('Please fill in all required fields!');
                return;
            }
            
            const bookId = bookIdInput ? bookIdInput.value : 'N/A';
            
            // Show preview in alert
            const preview = `üìö REST API Preview\n\nEndpoint: PUT /api/v1/books/${bookId}\nContent-Type: application/json\n\nRequest Body:\n${JSON.stringify(bookData, null, 2)}`;
            alert(preview);
            console.log('API Preview:', bookData);
        });
    });
    </script>
</body>
</html>
